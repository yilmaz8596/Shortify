@model IEnumerable<GetUrlVM>;

@{
    ViewData["Title"] = "All short links";
}

<div class="container mt-4">
    <!-- Success/Error Messages -->
    @if(TempData["Message"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            <strong>@TempData["Message"]</strong>
            @if(TempData["ShortUrl"] != null)
            {
                <div class="mt-2">
                    <a href="@TempData["ShortUrl"]" target="_blank" class="alert-link">
                        <code>@TempData["ShortUrl"]</code>
                        <i class="fas fa-external-link-alt ms-1 small"></i>
                    </a>
                </div>
            }
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if(TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>
            <strong>@TempData["Error"]</strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            @if(User.IsInRole("Admin"))
            {
                <span>All Short Links</span>
            }
            else
            {
                <span>My Short Links</span>
            }
        </h2>
        <button type="button" class="btn btn-primary-orange" data-bs-toggle="modal" data-bs-target="#createLinkModal">
            <i class="fas fa-plus me-2"></i>Create New Link
        </button>
    </div>
</div>

<div class="container">
    <div class="table-responsive">
        <table class="table table-striped table-hover table-centered">
            <thead>
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Original Link</th>
                    <th scope="col">Shortened Link</th>
                    <th scope="col">Clicks</th>
                    @if(User.IsInRole("Admin"))
                    {
                        <th scope="col">User</th>
                    }
                    <th scope="col">Created</th>
                    <th scope="col">Actions</th>
                </tr>
            </thead>
            <tbody>
                @if(Model != null && Model.Any())
                {
                    int index = 0;
                    @foreach(var url in Model)
                    {
                        index++;
                        <tr>
                            <td>@index</td>
                            <td>
                                <span class="url-link" title="@url.OriginalUrl">
                                    @url.OriginalUrl
                                </span>
                            </td>
                            <td>
                                <a href="@url.ShortenedUrl" target="_blank" class="text-decoration-none">
                                    <code>@url.ShortenedUrl</code>
                                    <i class="fas fa-external-link-alt ms-1 small"></i>
                                </a>
                            </td>
                            <td>
                                <span class="badge bg-info">@url.ClickCount</span>
                            </td>
                            @if(User.IsInRole("Admin"))
                            {
                                <td>@(url.User?.FullName ?? "Anonymous")</td>
                            }
                            <td>
                                <small class="text-muted">@url.CreatedAt.ToLocalTime().ToString("MMM dd, yyyy")</small>
                            </td>
                            <td>
                                <div class="btn-group" role="group">

                                    <!-- Delete button opens confirmation modal -->
                                    <button type="button"
                                            class="btn btn-outline-danger btn-sm ms-2 btn-delete"
                                            data-id="@url.Id"   
                                            data-original="@url.OriginalUrl"
                                            data-bs-toggle="modal"
                                            data-bs-target="#confirmDeleteModal"
                                            title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="@(User.IsInRole("Admin") ? "7" : "6")" class="text-center py-5">
                            <div class="d-flex flex-column align-items-center justify-content-center">
                                <i class="fas fa-link fa-3x text-primary-orange mb-3 opacity-50"></i>
                                <p class="mb-2 fw-bold fs-5">No shortened URLs found.</p>
                                <p class="text-muted mb-4">Create your first short link to get started!</p>
                                <button type="button" class="btn btn-primary-orange btn-lg" data-bs-toggle="modal" data-bs-target="#createLinkModal">
                                    <i class="fas fa-plus me-2"></i>Create Your First Link
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Create Link Modal -->
    <div class="modal fade" id="createLinkModal" tabindex="-1" aria-labelledby="createLinkLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header text-white" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                    <h5 class="modal-title" id="createLinkLabel">
                        <i class="fas fa-link me-2"></i>Create Short Link
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form asp-controller="Home" asp-action="ShortenUrl" method="post">
                    <div class="modal-body">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="returnUrl" value="@Url.Action("Index", "Url")" />
                        
                        <div class="mb-3">
                            <label for="urlInput" class="form-label fw-semibold">
                                <i class="fas fa-globe me-1 text-primary-orange"></i>
                                Enter your long URL
                            </label>
                            <input type="url" 
                                   class="form-control form-control-lg" 
                                   id="urlInput" 
                                   name="Url" 
                                   placeholder="https://example.com/very-long-url" 
                                   required 
                                   autocomplete="off">
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Make sure to include http:// or https://
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Cancel
                        </button>
                        <button type="submit" class="btn btn-primary-orange">
                            <i class="fas fa-scissors me-1"></i>Shorten URL
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmDeleteLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="deleteForm" asp-controller="Url" asp-action="Delete" method="post">
                    <div class="modal-body">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" id="deleteId" />
                        <p>Are you sure you want to delete this URL?</p>
                        <p class="fw-bold text-truncate" id="deleteOriginal" style="max-width:100%"></p>
                        <p class="text-danger small mb-0">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            This action cannot be undone.
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash me-1"></i>Yes, Delete
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Bootstrap 5 modal event: set id and preview for delete modal
        const confirmDeleteModal = document.getElementById('confirmDeleteModal');
        if (confirmDeleteModal) {
            confirmDeleteModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const id = button?.getAttribute('data-id') ?? '';
                const original = button?.getAttribute('data-original') ?? '';

                const deleteIdEl = document.getElementById('deleteId');
                const deleteOriginalEl = document.getElementById('deleteOriginal');
                if (deleteIdEl) deleteIdEl.value = id;
                if (deleteOriginalEl) deleteOriginalEl.textContent = original;
            });
        }

        // Clear create link modal when hidden
        const createLinkModal = document.getElementById('createLinkModal');
        if (createLinkModal) {
            createLinkModal.addEventListener('hidden.bs.modal', function () {
                document.getElementById('urlInput').value = '';
            });
        }

        // Auto-dismiss success alerts after 5 seconds
        setTimeout(function() {
            const alerts = document.querySelectorAll('.alert-dismissible');
            alerts.forEach(function(alert) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            });
        }, 5000);
    </script>
}
